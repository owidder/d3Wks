<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D3 Workshop</title>

    <link rel="stylesheet" type="text/css" href="css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="css/material-icons.css">

    <script src="lib/d3.v4.js"></script>

    <style>
        rect {
            stroke: black;
            stroke-width: 2px;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        .controls {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
        }

        .btn-floating {
            margin: 1em;
        }
    </style>
</head>
<body>

<div id="svgcontainer"></div>
<div class="screen">
    <div class="controls">
        <a class="btn-floating btn-large waves-effect waves-light blue" onclick="prev()"><i class="material-icons">skip_previous</i></a>
        <a class="btn-floating btn-large waves-effect waves-light blue" onclick="next()"><i class="material-icons">skip_next</i></a>
    </div>
</div>

<script>
    const width = window.innerWidth;
    const height = window.innerHeight;

    const BAR_OFFSET_X = 100;
    const BAR_OFFSET_Y = 100;
    const BAR_WIDTH = 50;
    const BAR_GAP = 10;
    const INITIAL_BAR_HEIGHT = 50;
    const BAR_BASELINE = height - BAR_OFFSET_Y;

    const svg = d3.select("#svgcontainer")
        .append("svg")
        .attr("height", height)
        .attr("width", width);

    const axisRoot = svg.append("g");
    axisRoot.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(" + (BAR_OFFSET_X - 10) + ",0)");

    let sortedWeeks = [];
    let currentWeek = -1;
    d3.json("data/bo.json", function (weekData) {
        sortedWeeks = weekData.sort(function (weekA, weekB) {
            return d3.ascending(weekA[0].date, weekB[0].date);
        });
    });

    function next() {
        if(sortedWeeks.length > 0) {
            if(currentWeek < sortedWeeks.length -1) {
                currentWeek += 1;
            }
            else {
                currentWeek = 0;
            }

            render();
        }
    }

    function prev() {
        if(sortedWeeks.length > 0) {
            if(currentWeek > 0) {
                currentWeek -= 1;
            }
            else {
                currentWeek = sortedWeeks.length;
            }

            render();
        }
    }

    const colorScale = d3.scaleOrdinal(d3.schemeCategory20);

    function render() {
        const weekData = sortedWeeks[currentWeek].slice(0, 10);
        const selection = svg.selectAll("rect")
            .data(weekData, function (d) {
                return d.title;
            });

        const maxWg = d3.max(weekData, function (d) {
            return d.wg;
        });

        const yFunc = d3.scaleLinear()
            .domain([0, maxWg])
            .range([BAR_BASELINE, 20]);
        const heightFunc = d3.scaleLinear()
            .domain([0, maxWg])
            .range([0, BAR_BASELINE - 20]);

        const t = axisRoot.transition().duration(1000);
        t.selectAll(".axis")
            .call(d3.axisLeft(yFunc));

        selection.enter()
            .append("rect")
            .attr("x", function(d, i) {
                return i * (BAR_WIDTH + BAR_GAP) + BAR_OFFSET_X;
            })
            .attr("y", BAR_BASELINE - INITIAL_BAR_HEIGHT)
            .attr("width", BAR_WIDTH)
            .attr("height", INITIAL_BAR_HEIGHT)
            .style("fill", function (d) {
                return colorScale(d.title);
            })
            .merge(selection)
            .transition()
            .duration(1000)
            .attr("x", function(d, i) {
                return i * (BAR_WIDTH + BAR_GAP) + BAR_OFFSET_X;
            })
            .attr("y", function (d) {
                return yFunc(d.wg);
            })
            .attr("height", function (d) {
                return heightFunc(d.wg);
            });

        selection.exit()
            .transition()
            .duration(500)
            .style("opacity", 0)
            .remove();

    }


</script>

</body>
</html>